# 寺子屋 - 辛口チャット型タスクメンター

朝にコミット、夜に決算、週1で"人生監査"。先延ばしを潰す、辛口チャット型タスク×メンター。

## プロダクト概要

**一文価値**: 朝にコミット、夜に決算、週1で"人生監査"。先延ばしを潰す、辛口チャット型タスク×メンター。

### できることは3つだけ

1. **朝コミット**: 今日やる最大3つを宣言（3つ固定）
2. **夜レポート**: 結果を報告（達成/未達＋一言）
3. **週次レビュー**: 1週間分を自動集計し、人生設計との整合性を"辛口"で返す

## 使い方

### 基本コマンド

- **朝**: `am: タスクA, タスクB, タスクC`（3つまで。2つでもOK）
- **夜**: `pm: A=done, B=done, C=miss(理由)`
- **トーン切替**: `/tone mild|sharp|dos`
- **通知時刻変更**: `/time am 07:30 pm 21:30 weekly Sun 19:00`
- **ヘルプ**: `/help`

### Quick Reply

Messaging API標準のQuick Replyで「am」「pm」「週次レビュー」を提供。

## 1日の流れ

1. **07:30** Botが「今日の3つ？」をPush → ユーザーが `am:` で返信
2. **21:30** Botが「結果は？」をPush → ユーザーが `pm:` で返信
3. **未報告なら 23:00** に1回だけ再通知（それでも無反応ならその日は"miss"集計）
4. **週次は 日曜 19:00** に自動配信（曜日/時刻は `/time` で変更可能）

## 個別スケジュール設定

ユーザー単位で朝/夜/週次/締切を設定可能。

### コマンド詳細

- `/time am HH:MM` 例: `/time am 06:45`
- `/time pm HH:MM` 例: `/time pm 22:00`
- `/time weekly <Sun|Mon|...> HH:MM` 例: `/time weekly Sun 19:00`
- `/deadline HH:MM` 例: `/deadline 23:30`（この時刻を過ぎた未報告は自動で miss）
- `/tz <IANA>`（任意。既定は Asia/Tokyo）

### 初期値

- am=07:30, pm=21:30, weekly=Sun 19:00, deadline=23:00
- 制約: HH:MMは24h表記。deadline は 20:00〜翌03:00 の範囲を許可（夜型OK）

## 週次レビュー

### 返す内容

- **達成率（%）**
- **アラインメント（0–1）**: 今週の実績が上位目標にどれだけ寄与したか
- **逃避タスク（最大3つ）**: 頻度高いのに成果薄い
- **来週の上位3タスク案**
- **一言（辛口）**: Mild/Sharp/Do-S に応じて文面変化

## 口調（トーン）

### Mild
事実＋提案＋励まし

### Sharp
事実＋矛盾指摘＋選択肢（短文・敬語省略）

### Do-S
事実＋非情な基準＋次の1手を強制コミット

**注意**: 人格攻撃・罵倒は禁止。危機ワード検知で自動Mild化＋ヘルプ表示。

## KPI（3つに限定）

1. **週次レビュー実施率**（目標≥65%）
2. **日次報告率**（am→pm完了率）
3. **1週間後継続率**（W1 Retention）

## セットアップ

### 1. 依存関係のインストール

```bash
npm install
```

### 2. 環境変数の設定

`env.example`をコピーして`.env`ファイルを作成し、以下の値を設定してください：

```bash
cp env.example .env
```

`.env`ファイルを編集：

```env
# LINE Messaging API設定
LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token_here
LINE_CHANNEL_SECRET=your_channel_secret_here

# サーバー設定
PORT=3000
WEBHOOK_URL=https://your-domain.com/webhook
```

### 3. LINE Developers Consoleでの設定

1. [LINE Developers Console](https://developers.line.biz/)にアクセス
2. プロバイダーとチャンネルを作成
3. Messaging APIチャンネルを作成
4. チャンネルアクセストークンとチャンネルシークレットを取得
5. Webhook URLを設定（例：`https://your-domain.com/webhook`）
6. Webhookの使用を有効化

### 4. サーバーの起動

開発環境：
```bash
npm run dev
```

本番環境：
```bash
npm start
```

## 使用方法

### ローカル開発

1. [ngrok](https://ngrok.com/)などのトンネリングサービスを使用してローカルサーバーを公開
2. ngrokでトンネルを作成：
   ```bash
   ngrok http 3000
   ```
3. 表示されたHTTPS URLをLINE Developers ConsoleのWebhook URLに設定

### 本番環境

1. クラウドサービス（Heroku、AWS、GCPなど）にデプロイ
2. 取得したURLをLINE Developers ConsoleのWebhook URLに設定

## API エンドポイント

### POST /webhook
LINE Messaging APIからのwebhookを受信するエンドポイント

### GET /health
サーバーのヘルスチェックエンドポイント

## 対応イベント

- **メッセージイベント**
  - テキストメッセージ（am:, pm:, コマンド）
  - Quick Reply対応

- **フォローイベント**
  - ユーザーがボットをフォローした時

- **アンフォローイベント**
  - ユーザーがボットをアンフォローした時

- **ポストバックイベント**
  - ポストバックアクションが実行された時

## 技術仕様

### データ管理
- メモリ内データベース（本番では外部DB推奨）
- ユーザー設定、タスク、週次統計を管理

### 定期実行
- node-cronを使用した1分毎の時刻チェック
- ユーザー個別のスケジュール設定に対応

### タイムゾーン対応
- moment-timezoneを使用
- ユーザー個別のタイムゾーン設定可能

## セキュリティ

- 署名検証により、LINEからのリクエストであることを確認
- 環境変数を使用してシークレット情報を管理
- エラーハンドリングによる堅牢性の確保

## トラブルシューティング

### よくある問題

1. **署名検証エラー**
   - チャンネルシークレットが正しく設定されているか確認
   - リクエストボディが正しく取得できているか確認

2. **リプライメッセージが送信されない**
   - チャンネルアクセストークンが正しく設定されているか確認
   - リプライトークンが有効期限内か確認

3. **Webhook URLが認識されない**
   - HTTPSでアクセス可能なURLか確認
   - サーバーが正常に起動しているか確認

4. **定期通知が動作しない**
   - サーバーの時刻設定を確認
   - タイムゾーン設定を確認

## ライセンス

MIT